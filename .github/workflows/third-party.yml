name: Third-Party Tests

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    types:
      - labeled
      - synchronize

env:
  RUSTFLAGS: "--cfg uuid_unstable"

jobs:
  langchain-core:
    name: Test langchain-core
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'third-party-tests')) ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout uuid-utils
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build and install uuid-utils from source
        run: |
          pip install maturin
          maturin build --release --out dist
          pip install uuid_utils --no-index --find-links dist --force-reinstall

      - name: Checkout langchain-core
        uses: actions/checkout@v4
        with:
          repository: langchain-ai/langchain
          path: langchain
          sparse-checkout: libs/core
          sparse-checkout-cone-mode: false

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Run langchain-core tests
        run: |
          cd langchain/libs/core
          make tests || echo "Some tests failed, but continuing to report results"

  langsmith-sdk:
    name: Test langsmith SDK
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'third-party-tests')) ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout uuid-utils
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build and install uuid-utils from source
        run: |
          pip install maturin
          maturin build --release --out dist
          pip install uuid_utils --no-index --find-links dist --force-reinstall

      - name: Checkout langsmith-sdk
        uses: actions/checkout@v4
        with:
          repository: langchain-ai/langsmith-sdk
          path: langsmith-sdk
          sparse-checkout: python
          sparse-checkout-cone-mode: false

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Run langsmith-sdk tests
        run: |
          cd langsmith-sdk/python
          make tests || echo "Some tests failed, but continuing to report results"
